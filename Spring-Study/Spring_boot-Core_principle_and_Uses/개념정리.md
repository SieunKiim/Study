# 스프링 부트 - 핵심 원리와 활용

## 웹 서버와 서블릿 컨테이너

### 외장 서버 vs 내장 서버

전통적인 방식으로는 먼저 서버에 톰캣과 같은 WAS를 설치했다. 이후, WAS에서 동작하도록 서블릿 스펙에 맞추어 코드를 작성하고, WAS에서 돌아갈 수 있도록 빌드를 통해 war 파일을 만들어 WAS에 전달해서 배포하는 방식으로 개발 주기가 동작했다.

하지만, 최근에는 스프링 부트가 내장 톰캣을 포함하고 있음.

애플리케이션 코드 안에 WAS가 라이브러리로 내장되어 있다는 뜻은, 개발자가 코드를 작성 후 JAR로 빌드 한 다음, 원하는 위치에서 실행하기만 하면 WAS가 같이 실행된다는 뜻.

어떤 원리로 스프링 부트가 내장 톰캣을 사용하여 실행할 수 있을까? Let's Go! 알아보자~

### JAR 알아보자

JAR는 Java Archive 의 줄임말이다. 해당 파일은 JVM 위에서 직접 실행되거나 라이브러리로 사용되기도 한다. (직접 실행되는 경우, main() 메서드가 필요하고 실행할 메인 클래스를 `MANIFEST.MF`파일에 지정해야 한다)

> 즉, Jar는 클래스와 관련 리소스를 압축한 단순 파일이다.

### WAR 알아보자

WAR는 Web Application Archive이다. 말 글대로 애플리케이션 서버 (WAS)에 배포할 때 사용하는 파일이다.

주요 차이는 JAR 는 JVM 위에서 실행되고, WAR 는 웹 어플리케이션 위에서 실행된다. (자연스럽게 WAR의 파일 구조가 JAR보다 조금 더 복잡하다)

- WAR의 구조

  - WEB-INF
    - classes (실행 클래스 모음)
    - lib (라이브러리 모음)
    - web.xml (웹 서버 배치 설정)
  - index.html (정적 리소스)

### WAS로 배포하기

일단 프로젝트를 빌드한다. (`./gradlew build`)

그러면 build.gradle에 있는 plugin 설정대로 파일이 만들어질 것이다 (WAR, 혹은 JAR)

> WAR 파일 안에는 뭐가 들어있을까? -> WEB-INF 폴더에는 클래스와 라이브러리들이 들어있다, WEB-INF 와 같은 폴더 위치에 index.html과 같은 정적 파일도 같이 들어있다.

빌드 결과로 나온 WAR 파일을 복사해서 톰캣의 `webapps` 폴더 하위에 넣는다. 필수로 파일명은 ROOT로 바꿔야한다(`ROOT.WAR`)

이제 톰켓을 실행시켜보자. 그러면 WAR 압축파일은 압축이 풀려지고 실행될것이다.

> 해당 과정을 intellij에서 실행 설정을 통해 지정할 수 있다.

<br>

## 서블릿 컨테이너 초기화

WAS를 실행하는 시점에 필요한 초기화 작업들이 있음.

- 서비스에 필요한 필터와 서블릿 등록.
- 스프링 컨테이너 만들기
- 스프링과 서블릿을 연결하는 디스페처 서블릿 등록

### 서블릿 컨테이너 초기화 해보기

서블릿은  `ServletContainerInitializer` 라는 초기화 인터페이스를 제공한다.
서블릿 컨테이너는 실행 시점에 초기화 메서드 `onStartup()`을 호출한다. 여기에서 애플리케이션에 필요한 기능을 초기화 하거나 등록할 수 있다.


## 애플리케이션 초기화

서블릿 컨테이너에서는 조금 더 유연한 초기화 기능을 지원한다.
여기선 이걸 애플리케이션 초기화 라고 부르자.

### WAR 배포 방식의 단점

웹 애플리케이션을 개발하고 배포하려면 여러 단계를 거쳐야 한다.

- WAS를 별도로 설치해야 함 (ex 톰캣)
- 애플리케이션 코드를 WAR로 빌드해야 한다.
- 빌드된 WAR 파일을 WAS에 배포한다.

-> `톰캣도 Java로 만들어져있는데 그럼 하나의 라이브러리로 생각하고 main 메서드 실행할 때 같이 동작하게 묶어주면 되지 않을까?` 라는 생각에서 내장 웹서버 (내장 톰캣) 을 활용하는 방법을 생각하게 됨

***

# 지금부터는 내장 톰켓을 활용해보자.

- 톰캣 설정하기
- 서블릿 등록하기
- 톰캣 시작하기

## 너가 알던 JAR는 JAR가 아니야

자바 표준으로 사용하는 Jar 에는 다른 Jar를 포함할 수 없고, 오로지 클래스로만 포함 가능하기에, 기타 라이브러리들을 전부 Class로 변환하여 합치는 형식으로 빌드하였다.

하지만, 스프링 부트에서 새롭게 정의한 Jar를 활용하여, Jar안에 Jar를 포함할 수 있도록 했다. 이를 통해 라이브러리 명이 겹치는 상황이나 ,기타 상황에서 문제없이 라이브러리들을 포함한 구조를 가질 수 있다.

그리햐아 실행되는 순서를 적어보자면 

> 1. `java -jar xxx.jar` 실행 명령
> 2. `MANIFEST.MF` 인식
> 3. `JavaLauncher.main()` 실행하여 다른 Jar파일 가져올 수 있도록 동작
>    클래스와 라이브러리 위치 지정을 통해 인식
> 4. `BootApplication.main()` 지정한 메인문 실해
